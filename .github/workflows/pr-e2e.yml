name: Playwright Tests
on:
  pull_request:
    branches: [ master ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  e2e-test:
    name: e2e-test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    container:
      image: mcr.microsoft.com/playwright:v1.47.0-jammy

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: npm i
      - name: Output Node & NPM info
        run: node --version && npm --version

      - name: Grant git permission
        run: git config --global --add safe.directory /__w/ts-etl-ui/ts-etl-ui

      - name: Build Angular
        run: npm run build:coverage

      - name: Run Playwright tests
        run: PR=${{ github.event.number }} npm run test

      - name: Upload Playwright HTML report to Azure
        shell: bash
        id: deploy-playwright-report
        run: |
          REPORT_DIR='run-${{ github.run_id }}-${{ github.run_attempt }}-playwright-report'
          azcopy cp --recursive "./playwright-report/*" "https://tsetlui.blob.core.windows.net/\$web/$REPORT_DIR"
          echo "::notice title=HTML report url::https://tsetlui.z1.web.core.windows.net/$REPORT_DIR/index.html"
        env:
          AZCOPY_AUTO_LOGIN_TYPE: SPN
          AZCOPY_SPA_APPLICATION_ID: '${{ secrets.AZCOPY_SPA_APPLICATION_ID }}'
          AZCOPY_SPA_CLIENT_SECRET: '${{ secrets.AZCOPY_SPA_CLIENT_SECRET }}'
          AZCOPY_TENANT_ID: '${{ secrets.AZCOPY_TENANT_ID }}'
      #
      #      - name: Merge both playwright & coverage report
      #        if: always()
      #        run: mv playwright-report coverage-e2e all-report
      #
      #      - name: Upload playwright report to artifact named github-pages # the next step's action expect this exactly artifact name
      #        if: always()
      #        uses: actions/upload-pages-artifact@v3
      #        with:
      #          path: all-report
      #
      #      - name: Deploy playwright report to GitHub Pages
      #        if: always()
      #        id: deploy-playwright-report-to-github-page
      #        uses: actions/deploy-pages@v4
      #        with:
      #          preview: true
      #
      #      - name: update job summary
      #        if: always()
      #        run: echo "# Deployed playwright report to ${{ steps.deploy-playwright-report-to-github-page.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY

      - name: update job summary
        if: always()
        run: echo "# Deployed playwright report to ${{ steps.deploy-playwright-report-to.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
